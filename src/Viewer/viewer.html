<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHPConsoleLog Viewer - {{KEY}}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #252526;
            padding: 10px 15px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 16px;
            font-weight: normal;
            color: #cccccc;
        }

        .header .key {
            color: #4ec9b0;
            font-weight: bold;
        }

        .header .status {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }

        .status-dot.connected {
            background: #4ec9b0;
            box-shadow: 0 0 5px #4ec9b0;
        }

        .status-dot.disconnected {
            background: #f48771;
        }

        .btn {
            padding: 5px 12px;
            background: #0e639c;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
            font-family: inherit;
        }

        .btn:hover {
            background: #1177bb;
        }

        .btn:active {
            background: #0d5a8f;
        }

        .console {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .log-entry {
            padding: 2px 0;
            display: flex;
            gap: 8px;
            border-bottom: 1px solid #2d2d30;
            font-size: 13px;
            line-height: 1.4;
        }

        .log-entry:hover {
            background: #2a2d2e;
        }

        .log-timestamp {
            color: #858585;
            flex-shrink: 0;
            min-width: 65px;
        }

        .log-level {
            flex-shrink: 0;
            min-width: 60px;
            font-weight: bold;
        }

        .log-level.debug {
            color: #858585;
        }

        .log-level.info {
            color: #4fc1ff;
        }

        .log-level.warning {
            color: #dcdcaa;
        }

        .log-level.error {
            color: #f48771;
        }

        .log-content {
            flex: 1;
            word-wrap: break-word;
        }

        .log-content pre {
            margin: 0;
            font-family: inherit;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .log-content .string {
            color: #ce9178;
        }

        .log-content .number {
            color: #b5cea8;
        }

        .log-content .boolean {
            color: #569cd6;
        }

        .log-content .null {
            color: #569cd6;
        }

        .log-content .key {
            color: #9cdcfe;
        }

        .log-content .object {
            color: #4ec9b0;
        }

        .log-content .exception {
            color: #f48771;
        }

        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #858585;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4e4e4e;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>PHPConsoleLog Viewer - <span class="key">{{KEY}}</span></h1>
        <div class="status">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Connecting...</span>
            </div>
            <button class="btn" id="clearBtn">Clear Console</button>
        </div>
    </div>
    
    <div class="console" id="log-console">
        <div class="empty-state" id="emptyState">
            Waiting for log messages...
        </div>
    </div>

    <script>
        const KEY = '{{KEY}}';
        const WS_URL = '{{WS_URL}}';
        
        let ws = null;
        let isConnected = false;
        let autoScroll = true;

        const logConsole = document.getElementById('log-console');
        const emptyState = document.getElementById('emptyState');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const clearBtn = document.getElementById('clearBtn');

        // Connect to WebSocket
        function connect() {
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                console.log('WebSocket connected');
                isConnected = true;
                updateStatus('connected', 'Connected');
                
                // Register with key
                ws.send(JSON.stringify({
                    action: 'register',
                    key: KEY
                }));
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                isConnected = false;
                updateStatus('disconnected', 'Disconnected');
                
                // Attempt to reconnect after 3 seconds
                setTimeout(connect, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateStatus('disconnected', 'Error');
            };
        }

        // Handle incoming messages
        function handleMessage(data) {
            switch (data.type) {
                case 'registered':
                    console.log('Registered with key:', data.key);
                    // Display buffered logs
                    if (data.bufferedLogs && data.bufferedLogs.length > 0) {
                        data.bufferedLogs.forEach(log => {
                            if (log.type === 'log') {
                                addLogEntry(log);
                            }
                        });
                    }
                    break;

                case 'log':
                    addLogEntry(data);
                    break;

                case 'cleared':
                    clearConsole();
                    break;

                case 'error':
                    console.error('Server error:', data.error);
                    break;
            }
        }

        // Add a log entry to the console
        function addLogEntry(log) {
            emptyState.classList.add('hidden');

            const entry = document.createElement('div');
            entry.className = 'log-entry';

            // Timestamp
            const timestamp = document.createElement('div');
            timestamp.className = 'log-timestamp';
            timestamp.textContent = formatTimestamp(log.timestamp);
            entry.appendChild(timestamp);

            // Level
            const level = document.createElement('div');
            level.className = `log-level ${log.level}`;
            level.textContent = log.level.toUpperCase();
            entry.appendChild(level);

            // Content
            const content = document.createElement('div');
            content.className = 'log-content';
            content.innerHTML = formatLogData(log.data);
            entry.appendChild(content);

            logConsole.appendChild(entry);

            // Auto-scroll to bottom
            if (autoScroll) {
                logConsole.scrollTop = logConsole.scrollHeight;
            }
        }

        // Format timestamp
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleTimeString('en-US', { hour12: false });
        }

        // Format log data for display
        function formatLogData(data) {
            if (!Array.isArray(data)) {
                return escapeHtml(String(data));
            }

            return data.map(item => formatItem(item)).join(' ');
        }

        // Format a single item
        function formatItem(item) {
            if (item === null) {
                return '<span class="null">null</span>';
            }

            if (typeof item === 'boolean') {
                return `<span class="boolean">${item}</span>`;
            }

            if (typeof item === 'number') {
                return `<span class="number">${item}</span>`;
            }

            if (typeof item === 'string') {
                return `<span class="string">${escapeHtml(item)}</span>`;
            }

            if (typeof item === 'object') {
                // Check for special types
                if (item._type === 'exception') {
                    return `<span class="exception">${escapeHtml(item.class)}: ${escapeHtml(item.message)} in ${escapeHtml(item.file)}:${item.line}</span>`;
                }

                if (item._type === 'object') {
                    if (item.value) {
                        return `<span class="object">${escapeHtml(item.class)}</span>: ${escapeHtml(item.value)}`;
                    }
                    return `<span class="object">${escapeHtml(item.class)}</span> ${formatObject(item.properties)}`;
                }

                if (item._type === 'resource') {
                    return `<span class="object">Resource(${escapeHtml(item.type)})</span>`;
                }

                // Regular object/array
                return formatObject(item);
            }

            return escapeHtml(String(item));
        }

        // Format object/array for display
        function formatObject(obj) {
            try {
                const json = JSON.stringify(obj, null, 2);
                return `<pre>${syntaxHighlightJson(json)}</pre>`;
            } catch (e) {
                return escapeHtml(String(obj));
            }
        }

        // Syntax highlight JSON
        function syntaxHighlightJson(json) {
            json = escapeHtml(json);
            json = json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, (match) => {
                let cls = 'number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'key';
                    } else {
                        cls = 'string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'boolean';
                } else if (/null/.test(match)) {
                    cls = 'null';
                }
                return `<span class="${cls}">${match}</span>`;
            });
            return json;
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Update connection status
        function updateStatus(status, text) {
            statusDot.className = `status-dot ${status}`;
            statusText.textContent = text;
        }

        // Clear console
        function clearConsole() {
            logConsole.innerHTML = '';
            emptyState.classList.remove('hidden');
            logConsole.appendChild(emptyState);
        }

        // Clear button click
        clearBtn.addEventListener('click', () => {
            if (isConnected) {
                ws.send(JSON.stringify({
                    action: 'clear',
                    key: KEY
                }));
            }
        });

        // Track auto-scroll preference
        logConsole.addEventListener('scroll', () => {
            const isAtBottom = logConsole.scrollHeight - logConsole.scrollTop <= logConsole.clientHeight + 50;
            autoScroll = isAtBottom;
        });

        // Start connection
        connect();
    </script>
</body>
</html>

